name: Detect Changes

on:
  workflow_call:
    outputs:
      deploy_functions:
        description: "Should deploy functions?"
        value: ${{ jobs.detect.outputs.deploy_functions }}
      deploy_hosting:
        description: "Should deploy hosting?"
        value: ${{ jobs.detect.outputs.deploy_hosting }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      deploy_functions: ${{ steps.check_changes.outputs.deploy_functions }}
      deploy_hosting: ${{ steps.check_changes.outputs.deploy_hosting }}
    steps:
      - name: Checkout Repository (Ensure Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure we get full commit history

      - name: Fetch and Compare Changes
        run: |
          # Ensure we have full history (especially for direct commits)
          git fetch --prune --unshallow
      
          # If this is a direct push to main, compare against the previous commit
          if [ "$GITHUB_REF_NAME" = "main" ]; then
            BASE_SHA=$(git rev-parse HEAD~1)
            echo "ðŸš€ Direct push detected! Comparing against previous commit: $BASE_SHA"
          else
            # If working in a PR, compare against origin/main
            git checkout main
            git pull origin main
            BASE_SHA=$(git rev-parse origin/main)
            echo "ðŸ“Œ PR detected! Comparing against: $BASE_SHA"
          fi
      
          echo "BASE_SHA=$BASE_SHA" >> "$GITHUB_ENV"
          
          # Debugging: Show Git Status and Logs
          echo "===== DEBUG: GIT STATUS ====="
          git status
          echo "===== DEBUG: GIT LOG ====="
          git log --oneline -5
          echo "===== DEBUG: GIT DIFF ====="
          git diff --name-status $BASE_SHA..HEAD
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD)
          echo "Changed files: $CHANGED_FILES"
      
          # Detect Functions changes
          if echo "$CHANGED_FILES" | grep -E '^functions/' > /dev/null; then
            echo "ðŸš€ Deploying Functions!"
            echo "deploy_functions=true" >> "$GITHUB_ENV"
            echo "deploy_functions=true" >> "$GITHUB_OUTPUT"
          else
            echo "No function changes detected."
            echo "deploy_functions=false" >> "$GITHUB_ENV"
            echo "deploy_functions=false" >> "$GITHUB_OUTPUT"
          fi
      
          # Detect Hosting (public/) changes
          if echo "$CHANGED_FILES" | grep -E '^public/|^firebase.json' > /dev/null; then
            echo "ðŸš€ Deploying Hosting!"
            echo "deploy_hosting=true" >> "$GITHUB_ENV"
            echo "deploy_hosting=true" >> "$GITHUB_OUTPUT"
          else
            echo "No hosting changes detected."
            echo "deploy_hosting=false" >> "$GITHUB_ENV"
            echo "deploy_hosting=false" >> "$GITHUB_OUTPUT"
          fi

