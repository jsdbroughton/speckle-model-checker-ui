name: Detect Changes

on:
  workflow_call:
    outputs:
      deploy_functions:
        description: "Should deploy functions?"
        value: ${{ jobs.detect.outputs.deploy_functions }}
      deploy_hosting:
        description: "Should deploy hosting?"
        value: ${{ jobs.detect.outputs.deploy_hosting }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      deploy_functions: ${{ steps.check_changes.outputs.deploy_functions }}
      deploy_hosting: ${{ steps.check_changes.outputs.deploy_hosting }}
    steps:
      - name: Checkout Repository (Ensure Main Exists)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ensures we have history for comparison

      - name: Fetch Main Branch
        run: git fetch origin main --depth=1

      - name: Detect Changes
        id: check_changes
        run: |
          # Determine the base commit to compare against
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="origin/main"
          fi
          echo "Comparing against: $BASE_SHA"

          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $GITHUB_SHA)
          echo "Changed files: $CHANGED_FILES"

          # Detect Functions changes (Fixing nested path detection)
          if echo "$CHANGED_FILES" | grep -E '^functions/|^functions$' > /dev/null; then
            echo "Deploying Functions!"
            echo "deploy_functions=true" >> "$GITHUB_ENV"
            echo "deploy_functions=true" >> "$GITHUB_OUTPUT"
          else
            echo "No function changes detected."
            echo "deploy_functions=false" >> "$GITHUB_ENV"
            echo "deploy_functions=false" >> "$GITHUB_OUTPUT"
          fi

          # Detect Hosting (public/) changes
          if echo "$CHANGED_FILES" | grep -E '^public/|^firebase.json' > /dev/null; then
            echo "Deploying Hosting!"
            echo "deploy_hosting=true" >> "$GITHUB_ENV"
            echo "deploy_hosting=true" >> "$GITHUB_OUTPUT"
          else
            echo "No hosting changes detected."
            echo "deploy_hosting=false" >> "$GITHUB_ENV"
            echo "deploy_hosting=false" >> "$GITHUB_OUTPUT"
          fi
